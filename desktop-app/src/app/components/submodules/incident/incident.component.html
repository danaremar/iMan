<!-- OPERATIONS -->
<div class="d-flex mb-3 mr-3 flex-wrap">
    <div class="flex-grow-1 center d-flex flex-wrap">
        <div class="d-flex mx-3" *ngIf="myProjects && myProjects.length!=0">
            <em class="bi bi-md bi-folder2 me-2" ngbTooltip="Project" placement="bottom" [openDelay]="300"></em>
            <select class="m-auto" (change)="loadProjectByIdEvent($event.target)">
                <option class="dark-text" *ngFor="let p of myProjects"
                    [attr.selected]="p.id==projectSelectedId?true:null" [ngValue]="p" value="{{p.id}}">
                    {{p.name}}</option>
            </select>
        </div>
    </div>
</div>

<hr style="height: 2px">

<div *ngIf="containError" class="alert alert-danger mt-3 mb-3">{{messageError}}</div>

<!-- TABLE -->
<div class="overflow-auto scrollable-content">
    <ag-grid-angular style="width: 100%; height: 100%" class="ag-theme-alpine-dark" [rowData]="incidents"
        [columnDefs]="incCol" [cacheBlockSize]="pageSize" [pagination]="true" [paginationPageSize]="pageSize"
        [enableRangeSelection]="true" (gridReady)="onGridReady($event)" [rowModelType]="'infinite'"
        (rowDoubleClicked)="loadSelectedRow($event)">

    </ag-grid-angular>
</div>

<!-- hidden button that opens modal -->
<button hidden type="button" #openViewModal class="btn btn-danger" data-bs-target="#viewModal"
    data-bs-toggle="modal"></button>

<!-- VIEW MODAL -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark-5">
            <div class="modal-body">
                <div class="card overflow-auto">

                    <div class="d-flex">
                        <div class="flex-grow-1 card-title mt-2">View incident</div>
                        <div class="close-card-button" data-bs-dismiss="modal">
                            <em class="bi bi-x"></em>
                        </div>
                    </div>

                    <!-- errors -->
                    <div *ngIf="incidentContainError" class="alert alert-danger mt-5">
                        {{incidentMessageError}}
                    </div>

                    <div class="container">

                        <div class="row">

                            <!-- INCIDENT CREATE / UPDATE -->
                            <form class="col-lg-5" *ngIf="selectedIncident!=undefined" [formGroup]="formIncident"
                                (ngSubmit)="uploadIncident()">

                                <!-- title -->
                                <div class="form-group mb-4 mt-3">
                                    <p class="mb-0">Title</p>
                                    <input id="formIncidentTitle"
                                        class="form-control {{inputClass(formIncident, 'title')}}" type="text"
                                        formControlName="title" maxlength="50" minlength="2" />
                                    <div class="invalid-feedback"
                                        *ngIf="formIncident.get('title')?.touched && formIncident.get('title')?.invalid">
                                        <div *ngIf="formIncident.get('title')?.errors?.maxlength">
                                            Only 50 characters are allowed
                                        </div>
                                    </div>
                                </div>

                                <!-- description -->
                                <div class="form-group mb-4 mt-3">
                                    <p class="mb-0">Description</p>
                                    <textarea class="form-control {{inputClass(formIncident, 'description')}}"
                                        nformControlName="description" maxlength="255" rows="3">
                                    </textarea>
                                    <div class="invalid-feedback"
                                        *ngIf="formIncident.get('description')?.touched && formIncident.get('description')?.invalid">
                                        <div *ngIf="formIncident.get('description')?.errors?.maxlength">
                                            Only 255 characters are allowed
                                        </div>
                                    </div>
                                </div>

                                <!-- reported -->
                                <div class="form-group mb-4 mt-3">
                                    <p class="mb-0">Reported by</p>
                                    <input class="form-control {{inputClass(formIncident, 'reported')}}" type="text"
                                        formControlName="reported" maxlength="50" />
                                    <div class="invalid-feedback"
                                        *ngIf="formIncident.get('reported')?.touched && formIncident.get('reported')?.invalid">
                                        <div *ngIf="formIncident.get('reported')?.errors?.maxlength">
                                            Only 30 characters are allowed
                                        </div>
                                    </div>
                                </div>

                                <!-- buttons -->
                                <div class="form-group modal-footer">
                                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal"
                                        #closeButtonIncident>Close</button>
                                    <button type="submit" class="btn btn-success"
                                        [disabled]="!formIncident.valid">Update</button>
                                </div>

                            </form>


                            <!-- INCIDENT UPDATES -->
                            <div class="col-lg-7">

                                <!-- INCIDENT CREATE UPDATES -->
                                <div class="accordion mt-1 mb-3" id="accordionIncidentUpdateCreate">

                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingOne">
                                            <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#collapseOne"
                                                aria-expanded="false" aria-controls="collapseOne">
                                                Create update
                                            </button>
                                        </h2>
                                        <div id="collapseOne" class="accordion-collapse collapse"
                                            aria-labelledby="headingOne"
                                            data-bs-parent="#accordionIncidentUpdateCreate">

                                            <div class="container">

                                                <form class="row" *ngIf="selectedIncident!=undefined"
                                                    [formGroup]="formIncidentUpdate"
                                                    (ngSubmit)="createNewIncidentUpdate()">

                                                    <!-- description -->
                                                    <div class="col-12 form-group mb-4 mt-3 form-floating">
                                                        <textarea
                                                            class="form-control {{inputClass(formIncident, 'description')}}"
                                                            formControlName="description" maxlength="255" rows="3">
                                                        </textarea>
                                                        <div class="invalid-feedback"
                                                            *ngIf="formIncident.get('description')?.touched && formIncident.get('description')?.invalid">
                                                            <div
                                                                *ngIf="formIncident.get('description')?.errors?.maxlength">
                                                                Only 255 characters are allowed
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- estimated time -->
                                                    <div class="col-6 d-flex me-3 my-1 form-floating">
                                                        <em class="bi bi-hourglass-top my-auto"
                                                            style="font-size: 20px !important;"></em>
                                                        <div class="my-auto mx-2">Estimated time: </div>
                                                        <input id="updEstimatedTime"
                                                            class="form-control {{inputClass(formIncidentUpdate, 'estimatedTime')}}"
                                                            type="number" step="0.5" formControlName="estimatedTime"
                                                            min="0" value="0" />
                                                        <div class="invalid-feedback"
                                                            *ngIf="formIncidentUpdate.get('estimatedTime')?.touched && formIncidentUpdate.get('estimatedTime')?.invalid">
                                                            <div
                                                                *ngIf="formIncidentUpdate.get('estimatedTime')?.errors?.min">
                                                                Cannot be negative time
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- priority -->
                                                    <div class="col-6 d-flex me-3 my-1">
                                                        <em class="bi bi-stoplights my-auto"
                                                            style="font-size: 20px !important;"></em>
                                                        <div class="my-auto mx-2">Priority: </div>
                                                        <input
                                                            class="form-control {{inputClass(formIncident, 'priority')}}"
                                                            type="text" formControlName="priority" maxlength="50" />
                                                        <div class="invalid-feedback"
                                                            *ngIf="formIncident.get('priority')?.touched && formIncident.get('priority')?.invalid">
                                                            <div
                                                                *ngIf="formIncident.get('priority')?.errors?.maxlength">
                                                                Only 50 characters are allowed
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- affects -->
                                                    <div class="col-6 d-flex me-3 my-1">
                                                        <em class="bi bi-shield-exclamation my-auto"
                                                            style="font-size: 20px !important;"></em>
                                                        <div class="my-auto mx-2">Affects: </div>
                                                        <input
                                                            class="form-control {{inputClass(formIncident, 'affects')}}"
                                                            type="text" formControlName="affects" list="lsAffects"
                                                            maxlength="50" />
                                                        <div class="invalid-feedback"
                                                            *ngIf="formIncident.get('affects')?.touched && formIncident.get('affects')?.invalid">
                                                            <div *ngIf="formIncident.get('affects')?.errors?.maxlength">
                                                                Only 50 characters are allowed
                                                            </div>
                                                        </div>
                                                        <datalist id="lsAffects">
                                                            <option>Scope</option>
                                                            <option>€</option>
                                                            <option>Scope & €</option>
                                                        </datalist>
                                                    </div>


                                                    <!-- assigned -->
                                                    <div class="col-6 d-flex me-3 my-1">
                                                        <em class="bi bi-person-check my-auto"
                                                            style="font-size: 20px !important;"></em>
                                                        <div class="my-auto mx-2">Assigned: </div>
                                                        <input
                                                            class="form-control {{inputClass(formIncident, 'assignedUsername')}}"
                                                            type="text" list="usersInProject"
                                                            formControlName="assignedUsername" maxlength="30"
                                                            minlength="2"/>
                                                        <div class="invalid-feedback"
                                                            *ngIf="formIncident.get('assignedUsername')?.touched && formIncident.get('assignedUsername')?.invalid">
                                                            <div
                                                                *ngIf="formIncident.get('assignedUsername')?.errors?.required">
                                                                Cannot be empty</div>
                                                            <div
                                                                *ngIf="formIncident.get('assignedUsername')?.errors?.minlength">
                                                                Must containt at least 2 characters</div>
                                                        </div>
                                                        <div
                                                            *ngIf="formIncident.get('assignedUsername')?.errors?.maxlength">
                                                            Only 30 characters are allowed</div>
                                                        <datalist id="usersInProject">
                                                            <option *ngFor="let u of usersInProject">{{u.username}}
                                                            </option>
                                                        </datalist>

                                                    </div>

                                                </form>

                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <!-- INCIDENT UPDATE HISTORY -->
                                <div class="overflow-auto scrollable-content" *ngIf="selectedIncident">

                                    <div class="card inc-upd-card p-3 mb-3"
                                        *ngFor="let u of selectedIncident.updates; let i = index">

                                        <!-- header -->
                                        <div class="d-flex flex-wrap">

                                            <!-- number -->
                                            <div class="m-text me-3 my-auto">#{{selectedIncident.updates.length - i}}</div>

                                            <!-- creator -->
                                            <div class="d-flex flex-grow-1">
                                                <ng-container
                                                    *ngIf="getProfileImageUrlFromUser(u.user)!=null && getProfileImageUrlFromUser(u.user)!=''; else showIconProfile">
                                                    <img class="profile-image me-2 my-auto"
                                                        src="{{getProfileImageUrlFromUser(u.user)}}" alt="Author"
                                                        ngbTooltip="Author" placement="right" [openDelay]="300">
                                                </ng-container>
                                                <ng-template #showIconProfile>
                                                    <em class="bi bi-person-circle me-2 my-auto"
                                                        style="font-size: 25px !important;" ngbTooltip="Author"
                                                        placement="right" [openDelay]="300"></em>
                                                </ng-template>
                                                <div class="my-auto" ngbTooltip="Author" placement="right"
                                                    [openDelay]="300">@{{u.user.username}}</div>
                                            </div>

                                            <!-- date -->
                                            <div class="d-flex">
                                                <em class="bi bi-calendar-date me-3 my-auto"
                                                    style="font-size: 20px !important;" ngbTooltip="Date"
                                                    placement="right" [openDelay]="300"></em>
                                                <div class="my-auto">{{getFormatedDate(u.date,'HH:mm:ss dd/MM/yyyy')}}
                                                </div>
                                            </div>

                                        </div>

                                        <!-- description -->
                                        <div class="text-break my-2">{{u.description}}</div>

                                        <!-- updates -> "body - description" -->
                                        <div class="d-flex flex-wrap">

                                            <!-- estimated time -->
                                            <div class="d-flex me-3 my-1" *ngIf="u.estimatedTime">
                                                <em class="bi bi-hourglass-top my-auto"
                                                    style="font-size: 20px !important;"></em>
                                                <div class="my-auto mx-2">Estimated time: {{u.estimatedTime}}</div>
                                            </div>

                                            <!-- priority -->
                                            <div class="d-flex me-3 my-1" *ngIf="u.priority">
                                                <em class="bi bi-stoplights my-auto"
                                                    style="font-size: 20px !important;"></em>
                                                <div class="my-auto mx-2">Priority: {{u.priority}}</div>
                                            </div>

                                            <!-- affects -->
                                            <div class="d-flex me-3 my-1" *ngIf="u.affects">
                                                <em class="bi bi-shield-exclamation my-auto"
                                                    style="font-size: 20px !important;"></em>
                                                <div class="my-auto mx-2">Affects: {{u.affects}}</div>
                                            </div>

                                            <!-- assigned -->
                                            <div *ngIf="u.assignedUser" class="d-flex flex-grow-1 me-3 my-1">
                                                <em class="bi bi-person-check my-auto"
                                                    style="font-size: 20px !important;"></em>
                                                <div class="my-auto mx-2">Assigned: </div>
                                                <ng-container
                                                    *ngIf="getProfileImageUrlFromUser(u.assignedUser)!=null && getProfileImageUrlFromUser(u.assignedUser)!=''; else showIconProfile">
                                                    <img class="profile-image me-2 my-auto"
                                                        src="{{getProfileImageUrlFromUser(u.assignedUser)}}"
                                                        alt="Assigned user" ngbTooltip="Author" placement="right"
                                                        [openDelay]="300"
                                                        style="height: 30px !important;width: 30px !important;">
                                                </ng-container>
                                                <ng-template #showIconProfile>
                                                    <em class="bi bi-person-circle me-2 my-auto"
                                                        style="font-size: 20px !important;" ngbTooltip="Assigned user"
                                                        placement="right" [openDelay]="300"></em>
                                                </ng-template>
                                                <div class="my-auto" ngbTooltip="Assigned user" placement="right"
                                                    [openDelay]="300">@{{u.assignedUser.username}}</div>
                                            </div>

                                        </div>
                                    </div>

                                </div>

                            </div>


                        </div>





                    </div>



                </div>
            </div>
        </div>
    </div>
</div>